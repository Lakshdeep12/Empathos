{% extends "base.html" %}

{% block title %}AI Chatbot - Empathos{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-robot"></i> Empathos AI Assistant
                </h4>
                <small>Available 24/7 to provide support and guidance</small>
            </div>
            <div class="card-body p-0">
                <!-- Chat Messages Container -->
                <div id="chat-messages" class="chat-container" style="height: 400px; overflow-y: auto; padding: 20px;">
                    <!-- Welcome Message -->
                    <div class="message bot-message mb-3">
                        <div class="message-content">
                            <div class="message-bubble bg-light p-3 rounded">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-robot text-primary me-2"></i>
                                    <strong>Empathos AI</strong>
                                </div>
                                <p class="mb-0">Hello {{ user.username }}! I'm here to support you. How are you feeling today? You can ask me anything about mental health, stress management, or just chat about your day. I'm here to listen and help.</p>
                            </div>
                            <small class="text-muted">Just now</small>
                        </div>
                    </div>
                    
                    <!-- Previous Messages -->
                    {% for message in chat_messages %}
                    <div class="message {% if message.user_id == user.id %}user-message{% else %}bot-message{% endif %} mb-3">
                        <div class="message-content">
                            <div class="message-bubble {% if message.user_id == user.id %}bg-primary text-white{% else %}bg-light{% endif %} p-3 rounded">
                                {% if message.user_id == user.id %}
                                    <p class="mb-0">{{ message.message }}</p>
                                {% else %}
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-robot text-primary me-2"></i>
                                        <strong>Empathos AI</strong>
                                    </div>
                                    <p class="mb-0">{{ message.response }}</p>
                                {% endif %}
                            </div>
                            <small class="text-muted">{{ message.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Message Input -->
                <div class="chat-input p-3 border-top">
                    <form id="chat-form" class="d-flex gap-2">
                        <div class="flex-grow-1">
                            <input type="text" id="message-input" class="form-control" placeholder="Type your message here..." required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Chat Tips -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-lightbulb"></i> Conversation Starters
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li><i class="fas fa-arrow-right text-info"></i> "I'm feeling stressed about work"</li>
                            <li><i class="fas fa-arrow-right text-info"></i> "How can I manage anxiety?"</li>
                            <li><i class="fas fa-arrow-right text-info"></i> "I'm having trouble sleeping"</li>
                            <li><i class="fas fa-arrow-right text-info"></i> "Can you help me with meditation?"</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-exclamation-triangle"></i> Important Notice
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-2"><strong>This AI assistant is for support and guidance only.</strong></p>
                        <p class="mb-0 small">For emergencies or serious mental health concerns, please contact:</p>
                        <ul class="list-unstyled small mb-0">
                            <li>• Emergency Services: 911</li>
                            <li>• Crisis Helpline: 988</li>
                            <li>• Professional mental health services</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.chat-container {
    background-color: #f8f9fa;
}

.message {
    display: flex;
    margin-bottom: 15px;
}

.user-message {
    justify-content: flex-end;
}

.user-message .message-content {
    max-width: 70%;
    text-align: right;
}

.bot-message .message-content {
    max-width: 70%;
}

.message-bubble {
    border-radius: 15px;
    word-wrap: break-word;
}

.user-message .message-bubble {
    border-bottom-right-radius: 5px;
}

.bot-message .message-bubble {
    border-bottom-left-radius: 5px;
}

.chat-input {
    background-color: white;
}

/* Scrollbar styling */
.chat-container::-webkit-scrollbar {
    width: 6px;
}

.chat-container::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.chat-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.chat-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatMessages = document.getElementById('chat-messages');
    
    // Scroll to bottom of chat
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Add message to chat
    function addMessage(message, isUser = false, timestamp = 'Just now') {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'} mb-3`;
        
        const icon = isUser ? 'fas fa-user' : 'fas fa-robot';
        const name = isUser ? '{{ user.username }}' : 'Empathos AI';
        const bgClass = isUser ? 'bg-primary text-white' : 'bg-light';
        
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-bubble ${bgClass} p-3 rounded">
                    ${!isUser ? `<div class="d-flex align-items-center mb-2">
                        <i class="fas fa-robot text-primary me-2"></i>
                        <strong>${name}</strong>
                    </div>` : ''}
                    <p class="mb-0">${message}</p>
                </div>
                <small class="text-muted">${timestamp}</small>
            </div>
        `;
        
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }
    
    // Handle form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message) return;
        
        // Add user message to chat
        addMessage(message, true);
        
        // Clear input
        messageInput.value = '';
        
        // Show typing indicator
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message bot-message mb-3';
        typingDiv.innerHTML = `
            <div class="message-content">
                <div class="message-bubble bg-light p-3 rounded">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-robot text-primary me-2"></i>
                        <strong>Empathos AI</strong>
                        <span class="ms-2">is typing...</span>
                    </div>
                </div>
            </div>
        `;
        chatMessages.appendChild(typingDiv);
        scrollToBottom();
        
        // Send message to server
        fetch('/send_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `message=${encodeURIComponent(message)}`
        })
        .then(response => response.json())
        .then(data => {
            // Remove typing indicator
            chatMessages.removeChild(typingDiv);
            
            if (data.error) {
                addMessage('Sorry, I encountered an error. Please try again.', false);
            } else {
                addMessage(data.response, false, data.timestamp);
            }
        })
        .catch(error => {
            // Remove typing indicator
            chatMessages.removeChild(typingDiv);
            addMessage('Sorry, I\'m having trouble connecting. Please try again.', false);
        });
    });
    
    // Auto-focus on input
    messageInput.focus();
    
    // Scroll to bottom on load
    scrollToBottom();
});
</script>
{% endblock %} 